<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"/>
<title>Ultimate ‚Äî Heatmap Musculaire V5</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
  :root{
    --bg:#0b0f16;
    --card:#11151b;
    --card-2:#131821;
    --accent:#F59E0B;
    --accent-2:#d97706;
    --muted:#8b92a8;
    --success:#10b981;
    --danger:#ef4444;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#07101a 0%, #0b0f16 60%);color:#fff;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
  header{background:linear-gradient(90deg,var(--accent),var(--accent-2));padding:18px;text-align:center;font-weight:800;color:#081018}
  .wrap{max-width:940px;margin:18px auto;padding:16px}
  .panel{background:var(--card);border-radius:14px;padding:16px;margin-bottom:16px;border:1px solid rgba(255,255,255,0.04)}
  .row{display:flex;gap:12px;align-items:center}
  .title{font-size:22px;color:var(--accent);font-weight:800;margin:6px 0}
  .muted{color:var(--muted)}
  .btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:none;padding:10px 14px;border-radius:10px;color:#081018;font-weight:800;cursor:pointer}
  .btn-ghost{background:var(--card-2);border:1px solid rgba(255,255,255,0.03);padding:9px 12px;border-radius:10px;color:#fff;cursor:pointer}
  .controls{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  /* prog list */
  .prog-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
  .prog-card{background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .muscle-tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .tag{background:rgba(245,158,11,0.12);padding:6px 10px;border-radius:999px;color:var(--accent);font-weight:700;font-size:13px}
  /* session view */
  .exercise-card{background:var(--card-2);padding:14px;border-radius:12px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03)}
  .exercise-name{font-weight:800;color:var(--accent);font-size:18px}
  .exercise-meta{color:var(--muted);margin-top:6px}
  .sets{margin-top:12px;display:flex;flex-direction:column;gap:10px}
  .set-row{display:flex;gap:8px;align-items:center}
  .set-input{background:#061018;border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,0.03);color:#fff;width:100%;text-align:center}
  .check{width:44px;height:44px;border-radius:50%;border:2px solid rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;cursor:pointer;background:var(--card);font-weight:800}
  .check.done{background:var(--success);border-color:var(--success);color:#04110b}
  .small-muted{color:var(--muted);font-size:13px}
  /* modal stats */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);z-index:2000;padding:20px}
  .modal.active{display:flex}
  .modal-card{width:100%;max-width:980px;background:var(--card);border-radius:14px;padding:18px;border:1px solid rgba(255,255,255,0.04)}
  .modal-head{display:flex;justify-content:space-between;align-items:center}
  .close{background:transparent;border:2px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;cursor:pointer;color:var(--accent)}
  /* SVG container */
  .svg-wrap{background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);display:flex;justify-content:center;align-items:center}
  svg{max-width:420px;width:100%;height:auto}
  /* responsive footer */
  footer{padding:18px;text-align:center;color:var(--muted);font-size:13px}
</style>
</head>
<body>
<header>Ultimate ‚Äî Heatmap Musculaire SVG (d√©taill√©e) ‚Äî V5</header>

<div class="wrap">
  <!-- top panel -->
  <div class="panel">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div>
        <div class="title">Donn√©es & graphiques</div>
        <div class="muted">Changer la semaine, ouvrir statistiques, exporter ou r√©initialiser.</div>
      </div>
      <div class="controls">
        <button id="prevWeek" class="btn-ghost">‚Üê Semaine -</button>
        <div style="padding:8px 12px;background:var(--card-2);border-radius:10px;border:1px solid rgba(255,255,255,0.03);font-weight:700" id="weekDisplay">Semaine 1</div>
        <button id="nextWeek" class="btn-ghost">Semaine + ‚Üí</button>
        <button id="openStats" class="btn">üìä Statistiques</button>
        <button id="exportCSV" class="btn-ghost">üíæ Export CSV</button>
        <button id="resetApp" class="btn-ghost" title="R√©initialiser">‚ôªÔ∏è Reset</button>
      </div>
    </div>
  </div>

  <!-- program / svg -->
  <div class="panel prog-grid" style="align-items:start">
    <div class="prog-card">
      <div class="title">Carte musculaire</div>
      <div class="muted">Couleurs selon intensit√© (direct & indirect) ‚Äî semaine courante</div>
      <div style="height:12px"></div>
      <div class="svg-wrap">
        <!-- Simplified anatomical SVG with muscle groups as shapes with ids (you can replace with more detailed shapes) -->
        <svg viewBox="0 0 400 800" xmlns="http://www.w3.org/2000/svg" id="muscleSvg" role="img" aria-label="Carte musculaire">
          <!-- torso front -->
          <g id="front">
            <rect x="120" y="40" width="160" height="240" rx="30" ry="30" fill="#081018"/>
            <!-- chest -->
            <path id="Pectoraux" d="M140 80 q60 -40 120 0 q-60 60 -120 0" fill="#0b1220" stroke="rgba(255,255,255,0.02)"/>
            <!-- abs -->
            <rect id="Abdominaux" x="170" y="140" width="60" height="120" rx="10" fill="#0b1220"/>
            <!-- quads left -->
            <rect id="Quadriceps" x="130" y="300" width="55" height="220" rx="18" fill="#081018"/>
            <!-- quads right -->
            <rect id="Quadriceps_R" x="215" y="300" width="55" height="220" rx="18" fill="#081018"/>
            <!-- psoas / hips -->
            <ellipse id="Fessiers" cx="200" cy="440" rx="70" ry="40" fill="#081018"/>
            <!-- biceps left -->
            <path id="Biceps" d="M90 110 q40 60 0 120 q-40 -40 0 -120" fill="#081018"/>
            <!-- biceps right -->
            <path id="Biceps_R" d="M310 110 q-40 60 0 120 q40 -40 0 -120" fill="#081018"/>
            <!-- forearms -->
            <rect id="Avant-bras" x="70" y="220" width="40" height="120" rx="8" fill="#081018"/>
            <rect id="Avant-bras_R" x="290" y="220" width="40" height="120" rx="8" fill="#081018"/>
            <!-- calves -->
            <rect id="Mollets" x="130" y="540" width="40" height="180" rx="12" fill="#081018"/>
            <rect id="Mollets_R" x="230" y="540" width="40" height="180" rx="12" fill="#081018"/>
            <!-- labels (optional small) -->
            <text x="200" y="35" fill="#fff" font-size="12" text-anchor="middle" opacity="0.85">Front</text>
          </g>

          <!-- back -->
          <g id="back" transform="translate(0,0)">
            <!-- back overlay shapes can be toggled similarly or drawn separately -->
            <path id="Dos" d="M140 80 q60 -40 120 0 q-20 120 -100 120 q-80 0 -120 -60" fill="transparent"/>
            <text x="200" y="760" fill="#fff" font-size="12" text-anchor="middle" opacity="0.6">Heatmap</text>
          </g>
        </svg>
      </div>
      <div style="margin-top:12px" class="small-muted">Les zones s'illuminent en orange proportionnellement √† la charge.</div>
    </div>

    <div class="prog-card">
      <div class="title">Programme ‚Äî Semaine active</div>
      <div class="muted" id="blockName">Bloc 1 ‚Äî Fondation</div>
      <div style="margin-top:12px" id="progListContainer"></div>
    </div>
  </div>

  <!-- Stats modal -->
  <div class="modal" id="statsModal" role="dialog" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div>
          <div style="font-weight:800;font-size:18px">Statistiques ‚Äî Semaine <span id="statWeek">1</span></div>
          <div class="muted">Volume par s√©ance et intensit√© musculaire (direct/indirect)</div>
        </div>
        <div>
          <button class="close" id="closeStats">Fermer ‚úñ</button>
        </div>
      </div>

      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
        <div style="flex:1;min-width:320px">
          <canvas id="chartVolume"></canvas>
        </div>
        <div style="flex:1;min-width:320px">
          <canvas id="chartMuscles"></canvas>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="exportCSVStats" class="btn">Exporter donn√©es</button>
        <button id="closeStatsBottom" class="btn-ghost">Fermer</button>
      </div>
    </div>
  </div>

  <div style="height:18px"></div>

  <!-- bottom info -->
  <div class="panel">
    <div class="title">Notes</div>
    <div class="muted">La heatmap combine : primary=3, secondary=2, tertiary=1, multipli√© par (sets √ó reps √ó poids) pour estimer l'intensit√©.</div>
  </div>

  <footer>¬© 2025 Ultimate ‚Äî V5</footer>
</div>

<script>
(function(){
  // --- DATA: Program + muscle mapping ---
  const MUSCLE_MAP = {
    "Trap Bar Deadlift": { primary: ["Quadriceps","Fessiers","Ischios"], secondary: ["Dos","Abdominaux"], tertiary: ["Mollets","Avant-bras"] },
    "Goblet Squat": { primary: ["Quadriceps","Fessiers"], secondary: ["Ischios","Abdominaux"], tertiary: ["Mollets"] },
    "Lat Pulldown": { primary: ["Dos","Grand dorsal"], secondary: ["Biceps","Avant-bras"], tertiary: ["√âpaules"] },
    "Leg Press": { primary: ["Quadriceps","Fessiers"], secondary: ["Ischios"], tertiary: ["Mollets"] },
    "Landmine Press": { primary: ["Pectoraux","√âpaules"], secondary: ["Triceps"], tertiary: ["Abdominaux"] },
    "Incline Curl": { primary: ["Biceps"], secondary: ["Avant-bras"], tertiary: [] },
    "Reverse Curl": { primary: ["Avant-bras"], secondary: ["Biceps"], tertiary: [] },
    "Dumbbell Press": { primary: ["Pectoraux"], secondary: ["√âpaules","Triceps"], tertiary: [] },
    "Close-Grip Bench Press": { primary: ["Triceps","Pectoraux"], secondary: ["√âpaules"], tertiary: [] },
    "Lateral Raises": { primary: ["√âpaules"], secondary: ["Trap√®zes"], tertiary: [] },
    "Face Pull": { primary: ["√âpaules post√©rieures","Rhombo√Ødes"], secondary: ["Trap√®zes"], tertiary: [] },
    "Cable Curl": { primary: ["Biceps"], secondary: ["Avant-bras"], tertiary: [] },
    "Rope Hammer Curl": { primary: ["Biceps","Avant-bras"], secondary: [], tertiary: [] },
    "Triceps Pushdown": { primary: ["Triceps"], secondary: [], tertiary: [] },
    "Landmine Row": { primary: ["Dos","Grand dorsal"], secondary: ["Biceps","Avant-bras"], tertiary: ["√âpaules"] },
    "Leg Curl": { primary: ["Ischios"], secondary: ["Fessiers"], tertiary: ["Mollets"] },
    "Leg Extension": { primary: ["Quadriceps"], secondary: [], tertiary: [] },
    "Dumbbell Fly": { primary: ["Pectoraux"], secondary: ["√âpaules"], tertiary: [] },
    "EZ Bar Curl": { primary: ["Biceps"], secondary: ["Avant-bras"], tertiary: [] },
    "Wrist Curl": { primary: ["Avant-bras"], secondary: [], tertiary: [] }
  };

  const PROGRAM = {
    dimanche: {
      key:'dimanche',
      title:"Dimanche - Dos + Jambes Lourdes",
      exercises:[
        {name:"Trap Bar Deadlift", sets:4, reps:"6-8", rest:150, weight:75},
        {name:"Goblet Squat", sets:3, reps:10, rest:90, weight:25},
        {name:"Lat Pulldown", sets:3, reps:10, rest:90, weight:60},
        {name:"Leg Press", sets:3, reps:12, rest:120, weight:110},
        {name:"Landmine Press", sets:3, reps:10, rest:120, weight:40},
        {name:"Incline Curl", sets:2, reps:12, rest:75, weight:14},
        {name:"Reverse Curl", sets:2, reps:15, rest:75, weight:8}
      ]
    },
    mardi: {
      key:'mardi',
      title:"Mardi - Pecs + √âpaules + Bras",
      exercises:[
        {name:"Dumbbell Press", sets:3, reps:10, rest:120, weight:22},
        {name:"Close-Grip Bench Press", sets:3, reps:10, rest:90, weight:70},
        {name:"Lateral Raises", sets:3, reps:15, rest:60, weight:8},
        {name:"Face Pull", sets:3, reps:15, rest:60, weight:20},
        {name:"Cable Curl", sets:3, reps:12, rest:75, weight:25},
        {name:"Rope Hammer Curl", sets:2, reps:15, rest:60, weight:12},
        {name:"Triceps Pushdown", sets:2, reps:12, rest:60, weight:25}
      ]
    },
    vendredi: {
      key:'vendredi',
      title:"Vendredi - Dos + Jambes L√©g√®res + Bras",
      exercises:[
        {name:"Landmine Row", sets:3, reps:10, rest:120, weight:50},
        {name:"Leg Curl", sets:3, reps:12, rest:90, weight:35},
        {name:"Leg Extension", sets:3, reps:15, rest:75, weight:40},
        {name:"Dumbbell Fly", sets:3, reps:12, rest:75, weight:12},
        {name:"EZ Bar Curl", sets:3, reps:12, rest:60, weight:30},
        {name:"Wrist Curl", sets:3, reps:20, rest:45, weight:8}
      ]
    }
  };

  // STATE
  const STATE_KEY = 'ultimate_v5_state';
  let state = loadState();

  function defaultState(){
    // create weights map
    const weights = {};
    Object.values(PROGRAM).forEach(s=>{
      s.exercises.forEach(e=>weights[e.name]=e.weight);
    });
    return { week:1, weights:weights, hist:{}, program:JSON.parse(JSON.stringify(PROGRAM)) };
  }
  function loadState(){
    try{
      const raw = localStorage.getItem(STATE_KEY);
      if(raw) return JSON.parse(raw);
    }catch(e){console.warn(e)}
    return defaultState();
  }
  function saveState(){ localStorage.setItem(STATE_KEY, JSON.stringify(state)); }

  // UI refs
  const weekDisplay = document.getElementById('weekDisplay');
  const blockName = document.getElementById('blockName');
  const progListContainer = document.getElementById('progListContainer');
  const prevWeekBtn = document.getElementById('prevWeek');
  const nextWeekBtn = document.getElementById('nextWeek');
  const openStatsBtn = document.getElementById('openStats');
  const statsModal = document.getElementById('statsModal');
  const closeStats = document.getElementById('closeStats');
  const closeStatsBottom = document.getElementById('closeStatsBottom');
  const exportCSV = document.getElementById('exportCSV');
  const exportCSVStats = document.getElementById('exportCSVStats');
  const resetApp = document.getElementById('resetApp');
  const statWeek = document.getElementById('statWeek');

  // Charts
  let chartVolume = null, chartMuscles = null;

  // Render initial
  renderHeader();
  renderProgramList();
  updateSvgHeatmap(); // initial

  // --- events
  prevWeekBtn.addEventListener('click', ()=>{ if(state.week>1) state.week--; saveState(); renderHeader(); renderProgramList(); updateSvgHeatmap(); });
  nextWeekBtn.addEventListener('click', ()=>{ if(state.week<26) state.week++; saveState(); renderHeader(); renderProgramList(); updateSvgHeatmap(); });
  openStatsBtn.addEventListener('click', ()=>{ openStats(); });
  closeStats.addEventListener('click', closeStatsModal);
  closeStatsBottom.addEventListener('click', closeStatsModal);

  statsModal.addEventListener('click', (e)=>{ if(e.target === statsModal) closeStatsModal(); });
  exportCSV.addEventListener('click', exportAllCSV);
  exportCSVStats.addEventListener('click', exportStatsCSV);
  resetApp.addEventListener('click', ()=>{
    if(confirm('R√©initialiser toutes les donn√©es (localStorage) ?')){
      localStorage.removeItem(STATE_KEY);
      state = defaultState();
      saveState();
      renderHeader();
      renderProgramList();
      updateSvgHeatmap();
      alert('R√©initialis√©');
    }
  });

  // --- render helpers ---
  function renderHeader(){
    weekDisplay.textContent = 'Semaine ' + state.week;
    blockName.textContent = getBlockInfo(state.week).name;
  }

  function renderProgramList(){
    progListContainer.innerHTML = '';
    Object.values(state.program).forEach(session=>{
      const wrapper = document.createElement('div');
      wrapper.className = 'exercise-card';
      const title = document.createElement('div');
      title.className = 'exercise-name';
      title.textContent = session.title;
      wrapper.appendChild(title);

      // list exercises
      session.exercises.forEach(ex=>{
        const exWrap = document.createElement('div');
        exWrap.style.marginTop = '10px';
        exWrap.style.paddingTop = '10px';
        exWrap.style.borderTop = '1px solid rgba(255,255,255,0.02)';

        const name = document.createElement('div');
        name.style.display = 'flex';
        name.style.justifyContent = 'space-between';
        name.style.alignItems = 'center';

        const left = document.createElement('div');
        left.innerHTML = '<div style="font-weight:700;color:var(--accent)">'+ex.name+'</div>' +
                         '<div class="muted small-muted">'+ex.sets+'√ó'+ (typeof ex.reps === 'number' ? ex.reps : String(ex.reps)) +' ‚Ä¢ '+ex.rest+'s ‚Ä¢ '+ (state.weights[ex.name]||ex.weight) +'kg</div>';
        name.appendChild(left);

        const arrow = document.createElement('div');
        arrow.innerHTML = '<button class="btn-ghost">Details</button>';
        name.appendChild(arrow);

        exWrap.appendChild(name);

        // muscle small tags
        const map = MUSCLE_MAP[ex.name] || {primary:[],secondary:[],tertiary:[]};
        const tags = document.createElement('div');
        tags.className = 'muscle-tags';
        map.primary.forEach(m=>{
          const t = document.createElement('div'); t.className='tag'; t.textContent = m; tags.appendChild(t);
        });
        map.secondary.forEach(m=>{
          const t = document.createElement('div'); t.className='tag'; t.style.opacity = 0.7; t.textContent = m; tags.appendChild(t);
        });
        map.tertiary.forEach(m=>{
          const t = document.createElement('div'); t.className='tag'; t.style.opacity = 0.5; t.textContent = m; tags.appendChild(t);
        });
        exWrap.appendChild(tags);

        wrapper.appendChild(exWrap);
      });

      progListContainer.appendChild(wrapper);
    });
  }

  function getBlockInfo(week){
    if(week<=5) return {name:'Bloc 1 - Fondation', tech:'Tempo contr√¥l√©'};
    if(week<=11) return {name:'Bloc 2 - Surcharge', tech:'Rest-Pause'};
    return {name:'Bloc 3 - Intensification', tech:'Drop-sets'};
  }

  // --- analytics: compute volumes and muscle loads for current week ---
  function parseReps(reps){
    if(typeof reps === 'number') return reps;
    // string range "6-8" -> choose top bound
    const s = String(reps).split('-')[0];
    const n = parseInt(s,10);
    return isNaN(n) ? 8 : n;
  }

  function computeSessionVolume(session){
    // session.volume = sum sets * reps * weight
    let vol = 0;
    session.exercises.forEach(ex=>{
      const reps = parseReps(ex.reps);
      const sets = ex.sets || 1;
      const weight = state.weights[ex.name] || ex.weight || 0;
      vol += sets * reps * weight;
    });
    return vol;
  }

  function computeMuscleWorkloadForWeek(week){
    // returns map muscle -> value
    const muscleWork = {};
    Object.values(state.program).forEach(session=>{
      session.exercises.forEach(ex=>{
        const map = MUSCLE_MAP[ex.name];
        const reps = parseReps(ex.reps);
        const sets = ex.sets || 1;
        const weight = state.weights[ex.name] || ex.weight || 0;
        const base = sets * reps * weight; // raw volume
        if(map){
          (map.primary||[]).forEach(m=>{
            muscleWork[m] = (muscleWork[m]||0) + base * 3;
          });
          (map.secondary||[]).forEach(m=>{
            muscleWork[m] = (muscleWork[m]||0) + base * 2;
          });
          (map.tertiary||[]).forEach(m=>{
            muscleWork[m] = (muscleWork[m]||0) + base * 1;
          });
        } else {
          // unknown map -> attribute to 'Autres'
          muscleWork['Autres'] = (muscleWork['Autres']||0) + base;
        }
      });
    });
    return muscleWork;
  }

  // --- Charts & Stats ---
  function openStats(){
    statWeek.textContent = state.week;
    renderCharts();
    statsModal.classList.add('active');
  }
  function closeStatsModal(){
    statsModal.classList.remove('active');
  }

  function renderCharts(){
    // Volume per session (bar)
    const sessionNames = Object.values(state.program).map(s=>s.title);
    const sessionVolumes = Object.values(state.program).map(s=>computeSessionVolume(s));

    const ctxV = document.getElementById('chartVolume');
    if(chartVolume) chartVolume.destroy();
    chartVolume = new Chart(ctxV, {
      type:'bar',
      data:{
        labels: sessionNames,
        datasets:[{
          label: 'Volume estim√© (kg √ó reps √ó sets)',
          data: sessionVolumes,
          backgroundColor: sessionNames.map((_,i)=>['rgba(245,158,11,0.9)','rgba(59,130,246,0.8)','rgba(139,92,246,0.8)'][i%3]),
          borderColor: '#081018',
          borderWidth: 1
        }]
      },
      options:{
        responsive:true,
        plugins:{ legend:{ display:false }, tooltip:{mode:'index'} },
        scales:{ y:{ beginAtZero:true, ticks:{color:'#fff'}, grid:{color:'rgba(255,255,255,0.04)'} }, x:{ ticks:{color:'#fff'} } }
      }
    });

    // Muscle radar
    const muscleWork = computeMuscleWorkloadForWeek(state.week);
    const muscles = Object.keys(muscleWork).sort((a,b)=>muscleWork[b]-muscleWork[a]).slice(0,12);
    const muscleData = muscles.map(m=>Math.round(muscleWork[m] || 0));
    const ctxM = document.getElementById('chartMuscles');
    if(chartMuscles) chartMuscles.destroy();
    chartMuscles = new Chart(ctxM, {
      type:'radar',
      data:{
        labels:muscles,
        datasets:[{
          label:'Intensit√© estim√©e (relative)',
          data:muscleData,
          backgroundColor:'rgba(245,158,11,0.18)',
          borderColor: 'rgba(245,158,11,1)',
          pointBackgroundColor: 'rgba(245,158,11,1)'
        }]
      },
      options:{
        responsive:true,
        scales:{ r:{ ticks:{color:'#fff'}, pointLabels:{color:'#fff'}, grid:{color:'rgba(255,255,255,0.04)'} } },
        plugins:{ legend:{ labels:{ color:'#fff' } } }
      }
    });
  }

  // --- SVG heatmap update ---
  function colorForValue(v, max){
    // map 0..max to transparent -> accent
    if(max<=0) return 'rgba(11,17,24,0.08)';
    const ratio = Math.min(1, v / max);
    // compute color: interpolate from very transparent orange to solid
    const alpha = 0.12 + 0.78 * ratio; // 0.12..0.9
    return `rgba(245,158,11,${alpha})`;
  }

  function updateSvgHeatmap(){
    // compute muscle workloads
    const muscleWork = computeMuscleWorkloadForWeek(state.week);
    // compute a max to normalize
    const vals = Object.values(muscleWork);
    const max = vals.length ? Math.max(...vals) : 0;

    // map to simple svg ids we created earlier
    // mapping muscle names to svg element ids (some normalized)
    const mapping = {
      'Quadriceps':'Quadriceps',
      'Fessiers':'Fessiers',
      'Ischios':'Quadriceps_R', // reused as right quad visually (simple)
      'Mollets':'Mollets',
      'Avant-bras':'Avant-bras',
      'Biceps':'Biceps',
      'Pectoraux':'Pectoraux',
      'Dos':'Dos',
      'Grand dorsal':'Dos',
      '√âpaules':'Biceps_R',
      'Triceps':'Pectoraux',
      'Abdominaux':'Abdominaux',
      '√âpaules post√©rieures':'Biceps_R',
      'Rhombo√Ødes':'Dos',
      'Autres':'Pectoraux'
    };

    // reset to base
    const svg = document.getElementById('muscleSvg');
    if(!svg) return;
    Object.values(mapping).forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.style.fill = '#0b1220';
    });

    // apply new fills
    Object.entries(muscleWork).forEach(([muscle, val])=>{
      const id = mapping[muscle] || muscle.replace(/\s+/g,'_');
      const el = document.getElementById(id);
      if(el){
        el.style.transition = 'fill 300ms';
        el.style.fill = colorForValue(val, max);
        // add tooltip title for quick hover on desktop
        if(!el.querySelector('title')){
          const t = document.createElementNS('http://www.w3.org/2000/svg','title');
          t.textContent = `${muscle}: ${Math.round(val)}`;
          el.appendChild(t);
        } else {
          el.querySelector('title').textContent = `${muscle}: ${Math.round(val)}`;
        }
      }
    });
  }

  // --- Exports ---
  function exportAllCSV(){
    // export weights & hist if any
    let csv = 'exercise,week,sets,reps,weight\n';
    Object.values(state.program).forEach(session=>{
      session.exercises.forEach(ex=>{
        csv += `${ex.name},${state.week},${ex.sets},${parseReps(ex.reps)},${state.weights[ex.name]||ex.weight}\n`;
      });
    });
    downloadBlob(csv, `ultimate_export_${new Date().toISOString().slice(0,10)}.csv`);
  }

  function exportStatsCSV(){
    // export muscle workloads per week (single week)
    const muscleWork = computeMuscleWorkloadForWeek(state.week);
    let csv = 'muscle,value,week\n';
    Object.entries(muscleWork).forEach(([m,v])=> csv += `${m},${Math.round(v)},${state.week}\n`);
    downloadBlob(csv, `ultimate_stats_week${state.week}_${new Date().toISOString().slice(0,10)}.csv`);
  }

  function downloadBlob(text, filename){
    const blob = new Blob([text], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // -- simple set timer (optional) --
  // not heavy; can be extended
  // Expose to window for debugging
  window.ultimate = {
    state, saveState, computeMuscleWorkloadForWeek, updateSvgHeatmap, renderCharts
  };

  // Re-render charts when modal open or week changes
  // Also update SVG periodically (when week changed)
  // Keep things snappy: recompute only on demand
})();
</script>
</body>
</html>
