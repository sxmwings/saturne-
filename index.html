<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"/>
<title>üèÜ Ultimate ‚Äî V5 (complet)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#0a0e17; --card:#151a25; --card-light:#1a202e; --accent:#F59E0B; --accent-dark:#d97706;
  --text:#ffffff; --muted:#8b92a8; --border:rgba(255,255,255,0.06);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;}
.container{max-width:920px;margin:0 auto;padding:20px;}
.header{padding:28px 12px;text-align:center}
.header h1{margin:0;font-size:28px;background:linear-gradient(135deg,var(--accent),#fbbf24);-webkit-background-clip:text;color:transparent}
.sub{color:var(--muted);margin-top:6px}

/* cards */
.card{background:var(--card);border-radius:14px;padding:18px;margin:14px 0;border:1px solid var(--border)}
.card-title{font-size:20px;color:var(--accent);font-weight:800;margin-bottom:8px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{background:var(--card-light);border:1px solid var(--border);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700}
.btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:#07101a;box-shadow:0 6px 16px rgba(245,158,11,0.2)}
.btn.danger{color:#ef4444;border-color:rgba(239,68,68,0.35)}
.small{font-size:13px;color:var(--muted)}

/* program list */
.program-card{border-radius:12px;padding:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border:1px solid var(--border);margin-bottom:12px}
.program-title{font-weight:800;color:var(--accent);font-size:18px}
.program-meta{color:var(--muted);font-size:13px;margin-bottom:8px}
.muscle-tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.muscle-tag{background:rgba(245,158,11,0.14);color:var(--accent);padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px;border:1px solid rgba(245,158,11,0.08)}

/* session view */
.session-header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.back-btn{background:var(--card);border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer}
.exercise-card{background:var(--card-light);border-radius:12px;padding:14px;margin-bottom:10px;border:1px solid var(--border)}
.exercise-top{display:flex;justify-content:space-between;align-items:center}
.exercise-name{font-weight:800;color:var(--accent);font-size:17px}
.exercise-meta{color:var(--muted);font-size:13px}

/* details */
.details{max-height:0;overflow:hidden;transition:max-height .36s ease;padding:0 0}
.details.open{padding:16px 0;max-height:2000px}
.tech{background:linear-gradient(90deg, rgba(245,158,11,0.08), rgba(251,191,36,0.06));border:1px solid rgba(245,158,11,0.18);padding:10px;border-radius:10px;color:var(--accent);font-weight:700;margin-bottom:12px}
.set-row{display:grid;grid-template-columns:110px 1fr 1fr 56px;gap:12px;align-items:center;margin-bottom:12px;padding:12px;background:var(--card);border-radius:10px;border:1px solid var(--border)}
.set-label{font-weight:800}
.input-label{font-size:11px;color:var(--muted);font-weight:800;margin-bottom:6px;text-transform:uppercase}
.set-input{background:var(--bg);border:2px solid var(--border);padding:12px;border-radius:10px;color:var(--text);font-weight:700;text-align:center;font-size:16px}
.set-checkbox{display:none}
.set-checkbox + label{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:3px solid var(--border);background:var(--card);cursor:pointer}
.set-checkbox:checked + label{background:var(--success);border-color:var(--success);transform:scale(1.06)}

/* rest timer */
.rest-timer{position:fixed;left:50%;transform:translateX(-50%);bottom:-260px;background:var(--card);padding:18px;border-radius:18px;border:1px solid var(--border);box-shadow:0 -12px 40px rgba(0,0,0,0.7);width:92%;max-width:420px;transition:bottom .45s cubic-bezier(.2,1,.3,1);z-index:999}
.rest-timer.visible{bottom:28px}
.timer-row{display:flex;gap:14px;align-items:center}
.timer-circle{position:relative;width:80px;height:80px}
.timer-text{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--accent)}
.timer-info{flex:1}
.timer-skip{background:rgba(239,68,68,0.15);border:2px solid rgba(239,68,68,0.35);width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#ef4444;cursor:pointer;font-weight:800}

/* modal stats */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);z-index:2000;padding:18px}
.modal.active{display:flex}
.modal-card{background:var(--card);border-radius:14px;padding:18px;max-width:860px;width:100%;border:1px solid var(--border)}
.modal-close{position:absolute;right:22px;top:18px;background:transparent;border:0;color:var(--accent);font-weight:900;cursor:pointer}
.chart-wrap{background:var(--card-light);padding:12px;border-radius:10px;margin-top:12px;border:1px solid var(--border)}

/* responsive */
@media(min-width:900px){
  .container{padding:32px}
  .header h1{font-size:36px}
}
</style>
</head>
<body>
<div class="container">
  <header class="header">
    <h1>Ultimate ‚Äî Heatmap & Stats</h1>
    <div class="sub">Programme HYBRID MASTER ‚Ä¢ 26 semaines ‚Ä¢ Demo V5</div>
  </header>

  <!-- Top controls -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div>
        <div class="card-title">Programme ‚Äî Semaine active</div>
        <div class="small" id="blockInfo">Bloc 1 - Fondation</div>
      </div>
      <div class="row">
        <button id="prevWeek" class="btn">‚Üê Semaine -</button>
        <div style="min-width:120px;text-align:center" id="weekDisplay" class="card-title">Semaine 1</div>
        <button id="nextWeek" class="btn primary">Semaine + ‚Üí</button>
      </div>
    </div>
  </div>

  <!-- Program list -->
  <div id="progList"></div>

  <!-- dashboard actions -->
  <div class="card">
    <div class="card-title">Tableau de bord</div>
    <div class="row" style="margin-top:10px">
      <button id="openStatsBtn" class="btn primary">üìä Statistiques</button>
      <button id="openHeatmapBtn" class="btn">üó∫Ô∏è Heatmap muscle</button>
      <button id="exportCSV" class="btn">üíæ Export CSV</button>
      <button id="backupBtn" class="btn">‚òÅÔ∏è Backup JSON</button>
      <button id="resetBtn" class="btn danger">‚ö†Ô∏è Reset</button>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Donn√©es & graphiques</div>
    <div class="small">Changer la semaine via les boutons en haut ‚Äî ouvrir Statistiques pour voir les graphes par s√©ance / muscle.</div>
  </div>

  <!-- Session (rendered dynamically when clicking a program) -->
  <div id="sessionContainer"></div>

</div>

<!-- rest timer -->
<div id="restTimer" class="rest-timer" aria-hidden="true">
  <div class="timer-row">
    <div class="timer-circle">
      <svg width="80" height="80" viewBox="0 0 80 80">
        <circle cx="40" cy="40" r="36" stroke="rgba(255,255,255,0.06)" stroke-width="6" fill="none"></circle>
        <circle id="timerProgress" cx="40" cy="40" r="36" stroke="#F59E0B" stroke-width="6" fill="none" stroke-linecap="round" style="stroke-dasharray:226;stroke-dashoffset:226;transform:rotate(-90deg);transform-origin:50% 50%;"></circle>
      </svg>
      <div class="timer-text" id="timerText">0:00</div>
    </div>
    <div class="timer-info">
      <div id="nextExerciseName" style="font-weight:800;color:var(--accent)">Repos</div>
      <div class="small">Temps de repos</div>
    </div>
    <div>
      <div id="skipRest" class="timer-skip">‚úï</div>
    </div>
  </div>
</div>

<!-- modal: stats -->
<div id="statsModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <button id="closeStats" class="modal-close">‚úñ</button>
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div>
        <div class="card-title">Statistiques ‚Äî Semaine <span id="statWeek">1</span></div>
        <div class="small">Volume / Muscles (direct & indirect)</div>
      </div>
      <div class="row">
        <select id="statSelect" class="btn" style="min-width:220px">
          <option value="all">Tout (par s√©ance)</option>
        </select>
        <button id="statExport" class="btn">Export CSV</button>
      </div>
    </div>

    <div class="chart-wrap">
      <canvas id="volumeChart" height="140"></canvas>
    </div>
    <div class="chart-wrap">
      <canvas id="muscleChart" height="140"></canvas>
    </div>
  </div>
</div>

<!-- modal: heatmap (simple SVG placeholder, interactive) -->
<div id="heatmapModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <button id="closeHeatmap" class="modal-close">‚úñ</button>
    <div class="card-title">Heatmap musculaire (Semaine <span id="heatWeek">1</span>)</div>
    <div style="margin-top:12px;color:var(--muted)">Les zones s'illuminent en orange proportionnellement √† la charge.</div>
    <div style="margin-top:18px;display:flex;justify-content:center">
      <!-- Simple illustrative SVG (you can replace with a detailed SVG) -->
      <svg id="muscleSVG" width="420" height="520" viewBox="0 0 420 520" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Carte musculaire">
        <defs>
          <linearGradient id="g1" x1="0" x2="1">
            <stop offset="0" stop-color="#000" stop-opacity="0"/>
            <stop offset="1" stop-color="#F59E0B" stop-opacity="0.6"/>
          </linearGradient>
        </defs>
        <rect x="0" y="0" width="420" height="520" rx="14" fill="url(#g1)" opacity="0.03"></rect>
        <!-- Torso simplified shapes with ids for each muscle -->
        <g id="muscles">
          <ellipse id="pectoraux" cx="210" cy="150" rx="120" ry="60" fill="#0f1620" stroke="#111" />
          <ellipse id="deltoides" cx="210" cy="90" rx="160" ry="38" fill="#0f1620" stroke="#111" />
          <ellipse id="biceps" cx="140" cy="210" rx="34" ry="60" fill="#0f1620" stroke="#111" />
          <ellipse id="triceps" cx="280" cy="210" rx="34" ry="60" fill="#0f1620" stroke="#111" />
          <ellipse id="abdos" cx="210" cy="240" rx="90" ry="60" fill="#0f1620" stroke="#111" />
          <ellipse id="quadriceps" cx="185" cy="380" rx="56" ry="90" fill="#0f1620" stroke="#111" />
          <ellipse id="ischios" cx="240" cy="420" rx="56" ry="60" fill="#0f1620" stroke="#111" />
          <ellipse id="mollets" cx="210" cy="470" rx="44" ry="40" fill="#0f1620" stroke="#111" />
          <ellipse id="dos" cx="210" cy="160" rx="100" ry="80" fill="none" stroke="rgba(255,255,255,0.03)"/>
        </g>
      </svg>
    </div>
    <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
      <div class="small">Legend: <span style="color:var(--accent);font-weight:800">Plus d'orange = plus de charge</span></div>
    </div>
  </div>
</div>

<script>
/* ============================
   FULL APP LOGIC ‚Äî V5
   ============================ */

(() => {
  'use strict';

  // ------------------------
  // Program + Muscle mapping
  // ------------------------
  const MUSCLE_MAPPING = {
    "Trap Bar Deadlift": { primary: ["Quadriceps","Fessiers","Ischios"], secondary:["Dos","Abdominaux"], tertiary:["Mollets","Avant-bras"] },
    "Goblet Squat": { primary:["Quadriceps","Fessiers"], secondary:["Ischios","Abdominaux"], tertiary:["Mollets"] },
    "Lat Pulldown": { primary:["Dos","Grand dorsal"], secondary:["Biceps","Avant-bras"], tertiary:["√âpaules"] },
    "Leg Press": { primary:["Quadriceps","Fessiers"], secondary:["Ischios"], tertiary:["Mollets"] },
    "Landmine Press": { primary:["Pectoraux","√âpaules"], secondary:["Triceps"], tertiary:["Abdominaux"] },
    "Incline Curl": { primary:["Biceps"], secondary:["Avant-bras"], tertiary:[] },
    "Reverse Curl": { primary:["Avant-bras"], secondary:["Biceps"], tertiary:[] },
    "Dumbbell Press": { primary:["Pectoraux"], secondary:["√âpaules","Triceps"], tertiary:[] },
    "Close-Grip Bench Press": { primary:["Triceps","Pectoraux"], secondary:["√âpaules"], tertiary:[] },
    "Lateral Raises": { primary:["√âpaules"], secondary:["Trap√®zes"], tertiary:[] },
    "Face Pull": { primary:["√âpaules post√©rieures","Rhombo√Ødes"], secondary:["Trap√®zes"], tertiary:[] },
    "Cable Curl": { primary:["Biceps"], secondary:["Avant-bras"], tertiary:[] },
    "Rope Hammer Curl": { primary:["Biceps","Avant-bras"], secondary:[], tertiary:[] },
    "Triceps Pushdown": { primary:["Triceps"], secondary:[], tertiary:[] },
    "Landmine Row": { primary:["Dos","Grand dorsal"], secondary:["Biceps","Avant-bras"], tertiary:["√âpaules"] },
    "Leg Curl": { primary:["Ischios"], secondary:["Fessiers"], tertiary:["Mollets"] },
    "Leg Extension": { primary:["Quadriceps"], secondary:[], tertiary:[] },
    "Dumbbell Fly": { primary:["Pectoraux"], secondary:["√âpaules"], tertiary:[] },
    "EZ Bar Curl": { primary:["Biceps"], secondary:["Avant-bras"], tertiary:[] },
    "Wrist Curl": { primary:["Avant-bras"], secondary:[], tertiary:[] }
  };

  const PROGRAM = {
    dimanche: {
      key: 'dimanche',
      title: "Dimanche - Dos + Jambes Lourdes",
      exercises: [
        { name: "Trap Bar Deadlift", sets: 4, reps: "6-8", rest: 150, weight: 75, tech: "Tempo 3-1-2" },
        { name: "Goblet Squat", sets: 3, reps: "10", rest: 90, weight: 25, tech: "Tempo 3-1-2" },
        { name: "Lat Pulldown", sets: 3, reps: "10", rest: 90, weight: 60, tech: "Tempo 2-1-2" },
        { name: "Leg Press", sets: 3, reps: "12", rest: 120, weight: 110, tech: "Tempo 2-1-2" },
        { name: "Landmine Press", sets: 3, reps: "10", rest: 120, weight: 40, tech: "Standard" },
        { name: "Incline Curl", sets: 2, reps: "12", rest: 75, weight: 14, tech: "Tempo 2-1-2" },
        { name: "Reverse Curl", sets: 2, reps: "15", rest: 75, weight: 8, tech: "Tempo 3-1-2" }
      ]
    },
    mardi: {
      key: 'mardi',
      title: "Mardi - Pecs + √âpaules + Bras",
      exercises: [
        { name: "Dumbbell Press", sets: 3, reps: "10", rest: 120, weight: 22, tech: "Tempo 2-1-2" },
        { name: "Close-Grip Bench Press", sets: 3, reps: "10", rest: 90, weight: 70, tech: "Standard" },
        { name: "Lateral Raises", sets: 3, reps: "15", rest: 60, weight: 8, tech: "Tempo 2-1-2" },
        { name: "Face Pull", sets: 3, reps: "15", rest: 60, weight: 20, tech: "Tempo 3-1-2" },
        { name: "Cable Curl", sets: 3, reps: "12", rest: 75, weight: 25, tech: "Standard" },
        { name: "Rope Hammer Curl", sets: 2, reps: "15", rest: 60, weight: 12, tech: "Standard" },
        { name: "Triceps Pushdown", sets: 2, reps: "12", rest: 60, weight: 25, tech: "Standard" }
      ]
    },
    vendredi: {
      key: 'vendredi',
      title: "Vendredi - Dos + Jambes L√©g√®res + Bras",
      exercises: [
        { name: "Landmine Row", sets: 3, reps: "10", rest: 120, weight: 50, tech: "Tempo 2-1-2" },
        { name: "Leg Curl", sets: 3, reps: "12", rest: 90, weight: 35, tech: "Tempo 3-1-2" },
        { name: "Leg Extension", sets: 3, reps: "15", rest: 75, weight: 40, tech: "Standard" },
        { name: "Dumbbell Fly", sets: 3, reps: "12", rest: 75, weight: 12, tech: "Tempo 3-1-2" },
        { name: "EZ Bar Curl", sets: 3, reps: "12", rest: 60, weight: 30, tech: "Standard" },
        { name: "Wrist Curl", sets: 3, reps: "20", rest: 45, weight: 8, tech: "Standard" }
      ]
    }
  };

  // ------------------------
  // State
  // ------------------------
  const STATE_KEY = 'ultimate_v5_state';
  let state = null;

  function defaultState(){
    const weights = {};
    Object.values(PROGRAM).forEach(s=> s.exercises.forEach(e=> weights[e.name]=e.weight));
    return { week: 1, weights, hist: {}, program: JSON.parse(JSON.stringify(PROGRAM)), custom: [] };
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STATE_KEY);
      if(raw) return JSON.parse(raw);
    }catch(e){ console.warn("load error",e) }
    return defaultState();
  }
  function saveState(){
    try{ localStorage.setItem(STATE_KEY, JSON.stringify(state)); }catch(e){ console.warn(e) }
  }

  state = loadState();

  // ------------------------
  // Helper UI utilities
  // ------------------------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  function show(el){ el.classList.add('active'); el.style.display='block'; }
  function hide(el){ el.classList.remove('active'); el.style.display='none'; }

  // ------------------------
  // Rendering functions
  // ------------------------
  const progListEl = $('#progList');
  const sessionContainer = $('#sessionContainer');
  const weekDisplay = $('#weekDisplay');
  const blockInfo = $('#blockInfo');

  function getBlockInfo(week){
    if(week<=5) return {name:'Bloc 1 - Fondation', tech:'Tempo contr√¥l√©'};
    if(week<=11) return {name:'Bloc 2 - Surcharge', tech:'Rest-Pause'};
    return {name:'Bloc 3 - Intensification', tech:'Drop-sets'};
  }

  function renderHeader(){
    weekDisplay.textContent = `Semaine ${state.week}`;
    blockInfo.textContent = getBlockInfo(state.week).name;
    $('#statWeek').textContent = state.week;
    $('#heatWeek').textContent = state.week;
  }

  function renderProgramList(){
    progListEl.innerHTML = '';
    Object.values(state.program).forEach(s=>{
      const card = document.createElement('div'); card.className='card program-card';
      card.innerHTML = `
        <div class="program-title">${s.title}</div>
        <div class="program-meta small">${s.exercises.length} exercices ‚Ä¢ ${s.exercises.reduce((a,b)=>a+b.sets,0)} s√©ries</div>
        <div class="muscle-tags"></div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn open-session" data-key="${s.key}">Ouvrir</button>
          <button class="btn details-session" data-key="${s.key}">D√©tails</button>
        </div>
      `;
      const tags = card.querySelector('.muscle-tags');
      // collect muscles across exercises
      const muscleSet = new Set();
      s.exercises.forEach(ex => {
        const m = MUSCLE_MAPPING[ex.name];
        if(m){ m.primary.forEach(x=>muscleSet.add(x)); m.secondary.forEach(x=>muscleSet.add(x)); m.tertiary.forEach(x=>muscleSet.add(x)); }
      });
      Array.from(muscleSet).slice(0,6).forEach(m=>{
        const t = document.createElement('div'); t.className='muscle-tag'; t.textContent = m; tags.appendChild(t);
      });
      progListEl.appendChild(card);
    });
  }

  // open session view
  function openSession(key){
    const sess = state.program[key];
    if(!sess) return;
    sessionContainer.innerHTML = '';
    const outer = document.createElement('div'); outer.className='card';
    outer.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><div class="card-title">${sess.title}</div><div class="small">Bloc: ${getBlockInfo(state.week).name}</div></div>
      <div><button class="btn back-btn" id="closeSession">‚Üê Retour</button></div>
    </div>`;
    const list = document.createElement('div'); list.style.marginTop='12px';

    sess.exercises.forEach((ex)=>{
      const exId = ex.name.replace(/[^a-zA-Z0-9]/g,'');
      const w = state.weights[ex.name] || ex.weight || 0;
      const card = document.createElement('div'); card.className='exercise-card';
      card.innerHTML = `
        <div class="exercise-top">
          <div>
            <div class="exercise-name">${ex.name}</div>
            <div class="exercise-meta small">${ex.sets}√ó${ex.reps} ‚Ä¢ ${ex.rest}s repos ‚Ä¢ ${w}kg</div>
            <div class="muscle-tags small" id="tags-${exId}"></div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button class="btn open-details" data-ex="${ex.name}" data-id="${exId}">D√©tails</button>
            <button class="btn" data-action="quickSave" data-ex="${ex.name}">‚úì Save</button>
          </div>
        </div>
        <div class="details" id="details-${exId}"></div>
      `;
      list.appendChild(card);

      // add muscle tags
      const mm = MUSCLE_MAPPING[ex.name] || {primary:[],secondary:[],tertiary:[]};
      const tagsWrap = card.querySelector(`#tags-${exId}`);
      mm.primary.forEach(m=>{ const el=document.createElement('div'); el.className='muscle-tag'; el.textContent=m; tagsWrap.appendChild(el); });
      mm.secondary.forEach(m=>{ const el=document.createElement('div'); el.className='muscle-tag'; el.style.opacity='.85'; el.textContent=m; tagsWrap.appendChild(el); });
      mm.tertiary.forEach(m=>{ const el=document.createElement('div'); el.className='muscle-tag'; el.style.opacity='.6'; el.textContent=m; tagsWrap.appendChild(el); });
    });

    outer.appendChild(list);
    sessionContainer.appendChild(outer);

    // attach close handler
    $('#closeSession').addEventListener('click', ()=> { sessionContainer.innerHTML = ''; });

    // scroll to session
    setTimeout(()=> outer.scrollIntoView({behavior:'smooth'}), 80);
  }

  // render details for exercise inline
  function renderExerciseDetails(exName){
    const exId = exName.replace(/[^a-zA-Z0-9]/g,'');
    const details = $(`#details-${exId}`);
    if(!details) return;
    // find exercise object
    let exObj = null;
    Object.values(state.program).forEach(s=> s.exercises.forEach(e=>{ if(e.name===exName) exObj=e; }));
    if(!exObj) return;
    const w = state.weights[exName] || exObj.weight || 0;
    const last = (state.hist[exName] && state.hist[exName].length>0) ? state.hist[exName][state.hist[exName].length-1] : null;
    let perfHtml = last ? `<div style="background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.18);padding:8px;border-radius:8px;margin-bottom:12px;color:#10b981;font-weight:700">Derni√®re: ${last.weight}kg √ó ${last.reps} reps (S${last.week})</div>` : `<div style="background:rgba(245,158,11,0.06);border:1px solid rgba(245,158,11,0.12);padding:8px;border-radius:8px;margin-bottom:12px;color:var(--accent);font-weight:700">Premi√®re fois pour cet exercice</div>`;
    let setsHtml = '';
    for(let i=1;i<=exObj.sets;i++){
      setsHtml += `<div class="set-row">
        <div>
          <div class="set-label">S√©rie ${i}</div>
        </div>
        <div>
          <div class="input-label">KG</div>
          <input type="number" class="set-input w-${exId}-${i}" value="${w}" step="0.5" />
        </div>
        <div>
          <div class="input-label">REPS</div>
          <input type="number" class="set-input r-${exId}-${i}" value="${parseInt(String(exObj.reps).split('-')[0])||0}" />
        </div>
        <div>
          <input id="s-${i}-${exId}" class="set-checkbox" type="checkbox" />
          <label for="s-${i}-${exId}"></label>
        </div>
      </div>`;
    }

    const techBanner = `<div class="tech">‚ú® ${exObj.tech}</div>`;
    details.innerHTML = techBanner + perfHtml + setsHtml + `
      <div style="display:flex;gap:10px;margin-top:10px">
        <button class="btn btn-save-ex" data-ex="${exName}">üíæ Enregistrer & Valider</button>
        <button class="btn" data-ex="${exName}" data-action="modifyWeight">‚úèÔ∏è Modifier poids</button>
      </div>
    `;

    // add checkbox listeners for rest timer
    $(`#details-${exId} .set-checkbox`)?.addEventListener && $(`#details-${exId} .set-checkbox`).addEventListener('change', ()=>{});
    // BUT since there are multiple checkboxes, attach individually:
    const cbs = $$('#details-'+exId+' .set-checkbox');
    cbs.forEach((cb, idx)=>{
      cb.addEventListener('change', function(){
        if(this.checked){
          const isLast = (idx === exObj.sets - 1);
          const nextText = isLast ? "Prochain exercice" : "Repos";
          startRestTimer(exObj.rest, nextText);
          if(navigator.vibrate) navigator.vibrate(60);
        }
      });
    });
  }

  // ------------------------
  // Events (delegation)
  // ------------------------
  document.addEventListener('click', (e)=>{
    const t = e.target;
    // open session
    if(t.closest('.open-session')){
      const key = t.closest('.open-session').dataset.key;
      openSession(key);
      return;
    }
    // details / open inline
    if(t.closest('.open-details')){
      const exName = t.closest('.open-details').dataset.ex;
      const exId = t.closest('.open-details').dataset.id;
      const details = document.getElementById('details-'+exId);
      if(details.classList.contains('open')){
        details.classList.remove('open'); details.innerHTML='';
      } else {
        renderExerciseDetails(exName);
        details.classList.add('open');
      }
      return;
    }
    // quickSave button
    if(t.dataset.action === 'quickSave'){
      const exName = t.dataset.ex;
      quickSavePerformance(exName);
      return;
    }
    // save performance from details
    if(t.classList.contains('btn-save-ex')){
      const exName = t.dataset.ex;
      savePerfFromDetails(exName);
      return;
    }
    // modify weight button
    if(t.dataset.action === 'modifyWeight'){
      const exName = t.dataset.ex;
      openModifyWeightModal(exName);
      return;
    }
  });

  // ------------------------
  // Save performance
  // ------------------------
  function savePerfFromDetails(exName){
    const exObj = findExercise(exName);
    if(!exObj) return;
    const exId = exName.replace(/[^a-zA-Z0-9]/g,'');
    const sets = [];
    for(let i=1;i<=exObj.sets;i++){
      const wEl = document.querySelector(`.w-${exId}-${i}`);
      const rEl = document.querySelector(`.r-${exId}-${i}`);
      if(wEl && rEl){
        const w = parseFloat(wEl.value) || 0;
        const r = parseInt(rEl.value) || 0;
        if(r>0) sets.push({w,r});
      }
    }
    if(sets.length===0){ alert('Entrez au moins une r√©p√©tition.'); return; }
    // choose best by reps
    const best = sets.reduce((a,b)=> b.r > a.r ? b : a);
    if(!state.hist[exName]) state.hist[exName]=[];
    state.hist[exName].push({ week: state.week, weight: best.w, reps: best.r, ts: Date.now(), allSets: sets });
    state.weights[exName] = best.w;
    saveState();
    alert(`Performance enregistr√©e: ${exName} ‚Äî ${best.w}kg √ó ${best.r} reps`);
    // re-render session to show updated meta
    const openSessionBtn = $$('.open-session').find(b=>b.dataset.key && b.dataset.key === currentOpenSession);
    if(currentOpenSession) openSession(currentOpenSession);
  }

  // simple quick save (single set) ‚Äî uses default weight/reps
  function quickSavePerformance(exName){
    const exObj = findExercise(exName);
    if(!exObj) return;
    const w = state.weights[exName] || exObj.weight || 0;
    const reps = parseInt(String(exObj.reps).split('-')[0]) || 8;
    if(!state.hist[exName]) state.hist[exName]=[];
    state.hist[exName].push({ week: state.week, weight: w, reps: reps, ts: Date.now(), allSets:[{w,reps}] });
    saveState();
    showToast(`Sauvegard√©: ${exName} ‚Äî ${w}kg √ó ${reps} reps`);
  }

  function findExercise(name){
    let found = null;
    Object.values(state.program).forEach(s=> s.exercises.forEach(e=>{ if(e.name===name) found=e; }));
    return found;
  }

  // ------------------------
  // Modify weight modal (simple prompt)
  // ------------------------
  function openModifyWeightModal(exName){
    const curr = state.weights[exName] || 0;
    const val = prompt(`Modifier poids par d√©faut pour ${exName} (kg) :`, curr);
    if(val===null) return;
    const nw = parseFloat(val);
    if(isNaN(nw) || nw<0){ alert('Valeur invalide'); return; }
    state.weights[exName]=nw; saveState();
    showToast(`Poids modifi√©: ${exName} ‚Üí ${nw} kg`);
    // re-render session if open
    if(currentOpenSession) openSession(currentOpenSession);
  }

  // ------------------------
  // Timer / Rest
  // ------------------------
  let restInterval = null;
  let restRemaining = 0;
  let restTotal = 1;
  const restPanel = $('#restTimer');
  const timerText = $('#timerText');
  const timerProgress = $('#timerProgress');
  const nextExerciseNameEl = $('#nextExerciseName');
  $('#skipRest').addEventListener('click', ()=> stopRestTimer());

  function startRestTimer(seconds, nextText){
    stopRestTimer();
    restTotal = Math.max(1, Math.floor(seconds));
    restRemaining = restTotal;
    nextExerciseNameEl.textContent = nextText || 'Repos';
    restPanel.classList.add('visible');
    restPanel.setAttribute('aria-hidden','false');
    updateRestUI();
    restInterval = setInterval(()=>{
      restRemaining--;
      if(restRemaining<=0){
        stopRestTimer();
        showToast('Repos termin√©');
        if(navigator.vibrate) navigator.vibrate([60,30,60]);
        playBeep();
      } else updateRestUI();
    },1000);
  }
  function updateRestUI(){
    const mm = Math.floor(restRemaining/60);
    const ss = restRemaining%60;
    timerText.textContent = `${mm}:${ss<10? '0'+ss : ss}`;
    const ratio = Math.max(0, restRemaining)/Math.max(1, restTotal);
    timerProgress.style.strokeDashoffset = 226 * ratio;
  }
  function stopRestTimer(){
    if(restInterval) clearInterval(restInterval);
    restInterval = null;
    restRemaining = 0; restTotal = 0;
    restPanel.classList.remove('visible');
    restPanel.setAttribute('aria-hidden','true');
    timerText.textContent = '0:00';
    timerProgress.style.strokeDashoffset = 226;
  }
  function playBeep(){
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.type='sine'; o.frequency.value=880;
      g.gain.setValueAtTime(0.2,ctx.currentTime);
      o.start(); o.stop(ctx.currentTime+0.35);
    }catch(e){}
  }

  // ------------------------
  // Stats modal + charts
  // ------------------------
  const statsModal = $('#statsModal'); const heatmapModal = $('#heatmapModal');
  const openStatsBtn = $('#openStatsBtn'); const closeStatsBtn = $('#closeStats');
  const openHeatBtn = $('#openHeatmapBtn'); const closeHeatBtn = $('#closeHeatmap');

  openStatsBtn.addEventListener('click', ()=> { openStats(); });
  closeStatsBtn.addEventListener('click', ()=> { closeStats(); });
  openHeatBtn.addEventListener('click', ()=> { openHeatmap(); });
  closeHeatBtn.addEventListener('click', ()=> { closeHeatmap(); });

  function openStats(){
    statsModal.classList.add('active'); statsModal.setAttribute('aria-hidden','false');
    $('#statSelect').innerHTML = '<option value="all">Tout (par s√©ance)</option>';
    Object.values(state.program).forEach(s => {
      const opt = document.createElement('option'); opt.value = s.key; opt.textContent = s.title; $('#statSelect').appendChild(opt);
    });
    renderStatsCharts();
  }
  function closeStats(){ statsModal.classList.remove('active'); statsModal.setAttribute('aria-hidden','true'); }
  function openHeatmap(){ heatmapModal.classList.add('active'); heatmapModal.setAttribute('aria-hidden','false'); renderHeatmap(); }
  function closeHeatmap(){ heatmapModal.classList.remove('active'); heatmapModal.setAttribute('aria-hidden','true'); }

  $('#statSelect').addEventListener('change', ()=> renderStatsCharts());
  $('#statExport').addEventListener('click', ()=> exportStatsCSV());

  let volumeChart = null; let muscleChart = null;

  function renderStatsCharts(){
    const sel = $('#statSelect').value;
    // labels: sessions or exercises
    if(sel === 'all'){
      const labels = Object.values(state.program).map(s => s.title);
      const data = Object.values(state.program).map(s => {
        // compute total volume = sum sets * reps(min) * weight (approx using default weight)
        let total = 0;
        s.exercises.forEach(ex => {
          const w = state.weights[ex.name] || ex.weight || 0;
          const reps = (typeof ex.reps === 'number') ? ex.reps : parseInt(String(ex.reps).split('-')[0]) || 0;
          total += w * reps * ex.sets;
        });
        return total;
      });
      renderBarChart('volumeChart', labels, data, `Volume par s√©ance ‚Äî Semaine ${state.week}`, '#ff9900');
    } else {
      const s = state.program[sel];
      const labels = s.exercises.map(e=>e.name);
      const data = s.exercises.map(ex => {
        const w = state.weights[ex.name] || ex.weight || 0;
        const reps = (typeof ex.reps === 'number') ? ex.reps : parseInt(String(ex.reps).split('-')[0]) || 0;
        return w * reps * ex.sets;
      });
      renderBarChart('volumeChart', labels, data, `${s.title} ‚Äî Volume (S${state.week})`, '#ff9900');
    }

    // muscle aggregated chart for selected week
    const muscleLoad = {};
    Object.values(state.program).forEach(s => {
      s.exercises.forEach(ex => {
        const weight = state.weights[ex.name] || ex.weight || 0;
        const reps = (typeof ex.reps === 'number') ? ex.reps : parseInt(String(ex.reps).split('-')[0]) || 0;
        const vol = weight * reps * ex.sets;
        const m = MUSCLE_MAPPING[ex.name];
        if(m){
          m.primary.forEach(x => muscleLoad[x] = (muscleLoad[x]||0) + vol * 1.0);
          m.secondary.forEach(x => muscleLoad[x] = (muscleLoad[x]||0) + vol * 0.6);
          m.tertiary.forEach(x => muscleLoad[x] = (muscleLoad[x]||0) + vol * 0.3);
        }
      });
    });
    // sort top muscles
    const entries = Object.entries(muscleLoad).sort((a,b)=>b[1]-a[1]);
    const muscleLabels = entries.map(e=>e[0]);
    const muscleData = entries.map(e=>Math.round(e[1]));
    renderBarChart('muscleChart', muscleLabels, muscleData, 'Muscles ‚Äî Charge estim√©e', '#F59E0B', true);
  }

  function renderBarChart(canvasId, labels, data, title, color='#F59E0B', horizontal=false){
    const ctx = document.getElementById(canvasId);
    if(!ctx) return;
    if(canvasId==='volumeChart' && volumeChart) { volumeChart.destroy(); volumeChart=null; }
    if(canvasId==='muscleChart' && muscleChart) { muscleChart.destroy(); muscleChart=null; }

    const cfg = {
      type: horizontal ? 'bar' : 'bar',
      data: {
        labels,
        datasets: [{ label: title, data, backgroundColor: color, borderColor: color, borderWidth:1 }]
      },
      options: {
        indexAxis: horizontal ? 'y' : 'x',
        plugins: { legend:{ display: false }, title:{display:true,text:title,color:'#fff',font:{weight:'700'}} },
        scales: {
          x: { ticks:{color:'#fff'}, grid:{color:'rgba(255,255,255,0.03)'} },
          y: { ticks:{color:'#fff'}, grid:{color:'rgba(255,255,255,0.03)'} }
        }
      }
    };
    if(canvasId==='volumeChart') volumeChart = new Chart(ctx, cfg);
    if(canvasId==='muscleChart') muscleChart = new Chart(ctx, cfg);
  }

  function exportStatsCSV(){
    let csv = 'Element,Value\n';
    // export muscle chart or volume currently rendered
    if(muscleChart && muscleChart.data){
      muscleChart.data.labels.forEach((l,i)=> csv += `${l},${muscleChart.data.datasets[0].data[i]}\n`);
    } else if(volumeChart && volumeChart.data){
      volumeChart.data.labels.forEach((l,i)=> csv += `${l},${volumeChart.data.datasets[0].data[i]}\n`);
    } else { alert('Rien √† exporter'); return; }
    const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `stats_export_${(new Date()).toISOString().slice(0,10)}.csv`; a.click();
  }

  // ------------------------
  // Heatmap rendering (simple)
  // ------------------------
  function renderHeatmap(){
    // compute muscle workload
    const muscleLoad = {};
    Object.values(state.program).forEach(s => {
      s.exercises.forEach(ex => {
        const weight = state.weights[ex.name] || ex.weight || 0;
        const reps = (typeof ex.reps === 'number') ? ex.reps : parseInt(String(ex.reps).split('-')[0]) || 0;
        const vol = weight * reps * ex.sets;
        const m = MUSCLE_MAPPING[ex.name];
        if(m){
          m.primary.forEach(x => muscleLoad[x] = (muscleLoad[x]||0) + vol * 1.0);
          m.secondary.forEach(x => muscleLoad[x] = (muscleLoad[x]||0) + vol * 0.6);
          m.tertiary.forEach(x => muscleLoad[x] = (muscleLoad[x]||0) + vol * 0.3);
        }
      });
    });
    // map to simplified SVG ids
    const map = {
      "Pectoraux": "pectoraux",
      "√âpaules": "deltoides",
      "√âpaules post√©rieures": "deltoides",
      "Biceps": "biceps",
      "Avant-bras": "biceps",
      "Triceps": "triceps",
      "Abdominaux": "abdos",
      "Quadriceps": "quadriceps",
      "Ischios": "ischios",
      "Mollets": "mollets",
      "Dos": "dos",
      "Grand dorsal": "dos",
      "Fessiers": "ischios"
    };
    // determine max
    const max = Math.max(1, ...Object.values(muscleLoad));
    // update SVG fill
    Object.entries(map).forEach(([muscle,id])=>{
      const el = document.getElementById(id);
      if(!el) return;
      const val = muscleLoad[muscle] || 0;
      const intensity = Math.min(1, val / max);
      const color = `rgba(245,158,11,${0.12 + intensity*0.6})`;
      el.style.transition = 'fill 0.3s ease, opacity 0.3s ease';
      el.setAttribute('fill', color);
      if(intensity>0) el.setAttribute('stroke', 'rgba(245,158,11,0.35)');
      else el.setAttribute('stroke', '#111');
    });
  }

  // ------------------------
  // CSV / Backup / Reset
  // ------------------------
  $('#exportCSV').addEventListener('click', ()=> {
    let csv = 'Exercise,Week,Set,Reps,Weight,Timestamp\n';
    Object.entries(state.hist).forEach(([ex,records])=>{
      records.forEach(r=>{
        if(r.allSets) r.allSets.forEach((s,i)=> csv += `"${ex}",${r.week},${i+1},${s.r},${s.w},"${new Date(r.ts).toLocaleString()}"\n`);
        else csv += `"${ex}",${r.week},1,${r.reps},${r.weight},"${new Date(r.ts).toLocaleString()}"\n`;
      });
    });
    const blob = new Blob([csv], {type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`hm51_hist_${(new Date()).toISOString().slice(0,10)}.csv`; a.click();
    showToast('Export CSV t√©l√©charg√©');
  });

  $('#backupBtn').addEventListener('click', ()=> {
    const payload = JSON.stringify(state, null, 2);
    const blob = new Blob([payload], {type:'application/json'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `hm51_backup_${(new Date()).toISOString().slice(0,10)}.json`; a.click();
    showToast('Backup JSON t√©l√©charg√©');
  });

  $('#resetBtn').addEventListener('click', ()=> {
    if(!confirm('R√©initialiser toutes les donn√©es (localStorage) ?')) return;
    localStorage.removeItem(STATE_KEY); state = defaultState(); saveState(); renderProgramList(); renderHeader(); sessionContainer.innerHTML=''; showToast('R√©initialis√©');
  });

  // ------------------------
  // Week controls
  // ------------------------
  $('#nextWeek').addEventListener('click', ()=> { state.week = Math.min(26, state.week+1); saveState(); renderHeader(); });
  $('#prevWeek').addEventListener('click', ()=> { state.week = Math.max(1, state.week-1); saveState(); renderHeader(); });

  // ------------------------
  // small toast
  // ------------------------
  function showToast(msg, time=1800){
    const t = document.createElement('div'); t.textContent = msg;
    t.style = 'position:fixed;left:50%;transform:translateX(-50%);bottom:40px;background:rgba(0,0,0,0.7);color:#fff;padding:10px 16px;border-radius:10px;font-weight:700;z-index:9999';
    document.body.appendChild(t);
    setTimeout(()=>{ t.style.transition='opacity .3s'; t.style.opacity='0'; setTimeout(()=>t.remove(),350); }, time);
  }

  // ------------------------
  // small utilities
  // ------------------------
  let currentOpenSession = null;
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.matches('.details-session')){
      const key = e.target.dataset.key;
      // show modal details summary
      const sess = state.program[key];
      if(!sess) return;
      currentOpenSession = key;
      const lines = sess.exercises.map(ex=>{
        const w = state.weights[ex.name] || ex.weight || 0;
        const reps = (typeof ex.reps === 'number') ? ex.reps : String(ex.reps);
        return `${ex.name} ‚Äî ${ex.sets}√ó${reps} ‚Ä¢ ${ex.rest}s ‚Ä¢ ${w}kg`;
      }).join('\n');
      alert(`${sess.title}\n\n${lines}`);
    }
  });

  // ------------------------
  // init
  // ------------------------
  function init(){
    renderHeader();
    renderProgramList();
    // fill stat select initial
    $('#statWeek').textContent = state.week;
    $('#heatWeek').textContent = state.week;
    // close modal clicking outside
    statsModal.addEventListener('click', (ev)=>{ if(ev.target===statsModal) closeStats(); });
    heatmapModal.addEventListener('click', (ev)=>{ if(ev.target===heatmapModal) closeHeatmap(); });
    // set current open session var on open
    document.addEventListener('click', (ev)=>{
      const os = ev.target.closest('.open-session');
      if(os) currentOpenSession = os.dataset.key;
    });
  }

  init();

  // expose some helpers to window for debugging if needed
  window.UM = {
    state, saveState, renderProgramList, openSession, renderHeatmap, renderStatsCharts
  };

})();
</script>
</body>
</html>
